var SSE=function(n,t){if(!(this instanceof SSE))return new SSE(n,t);this.INITIALIZING=-1;this.CONNECTING=0;this.OPEN=1;this.CLOSED=2;this.url=n;t=t||{};this.headers=t.headers||{};this.payload=t.payload!==undefined?t.payload:"";this.method=t.method||this.payload&&"POST"||"GET";this.withCredentials=!!t.withCredentials;this.debug=!!t.debug;this.FIELD_SEPARATOR=":";this.listeners={};this.xhr=null;this.readyState=this.INITIALIZING;this.progress=0;this.chunk="";this.lastEventId="";this.addEventListener=function(n,t){this.listeners[n]===undefined&&(this.listeners[n]=[]);this.listeners[n].indexOf(t)===-1&&this.listeners[n].push(t)};this.removeEventListener=function(n,t){if(this.listeners[n]!==undefined){const i=[];this.listeners[n].forEach(function(n){n!==t&&i.push(n)});i.length===0?delete this.listeners[n]:this.listeners[n]=i}};this.dispatchEvent=function(n){if(!n)return!0;this.debug&&console.debug(n);n.source=this;const t="on"+n.type;return this.hasOwnProperty(t)&&(this[t].call(this,n),n.defaultPrevented)?!1:this.listeners[n.type]?this.listeners[n.type].every(function(t){return t(n),!n.defaultPrevented}):!0};this._setReadyState=function(n){const t=new CustomEvent("readystatechange");t.readyState=n;this.readyState=n;this.dispatchEvent(t)};this._onStreamFailure=function(n){const t=new CustomEvent("error");t.data=n.currentTarget.response;this.dispatchEvent(t);this.close()};this._onStreamAbort=function(){this.dispatchEvent(new CustomEvent("abort"));this.close()};this._onStreamProgress=function(n){if(this.xhr){if(this.xhr.status!==200){this._onStreamFailure(n);return}this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this._setReadyState(this.OPEN));const t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;const i=(this.chunk+t).split(/(\r\n\r\n|\r\r|\n\n)/g),r=i.pop();i.forEach(function(n){n.trim().length>0&&this.dispatchEvent(this._parseEventChunk(n))}.bind(this));this.chunk=r}};this._onStreamLoaded=function(n){this._onStreamProgress(n);this.dispatchEvent(this._parseEventChunk(this.chunk));this.chunk=""};this._parseEventChunk=function(n){if(!n||n.length===0)return null;this.debug&&console.debug(n);const t={id:null,retry:null,data:null,event:null};n.split(/\n|\r\n|\r/).forEach(function(n){const r=n.indexOf(this.FIELD_SEPARATOR);let i,u;if(r>0){const t=n[r+1]===" "?2:1;i=n.substring(0,r);u=n.substring(r+t)}else if(r<0)i=n,u="";else return;i in t&&(i==="data"&&t[i]!==null?t.data+="\n"+u:t[i]=u)}.bind(this));t.id!==null&&(this.lastEventId=t.id);const i=new CustomEvent(t.event||"message");return i.id=t.id,i.data=t.data||"",i.lastEventId=this.lastEventId,i};this._checkStreamClosed=function(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this._setReadyState(this.CLOSED)};this.stream=function(){if(!this.xhr){this._setReadyState(this.CONNECTING);this.xhr=new XMLHttpRequest;this.xhr.addEventListener("progress",this._onStreamProgress.bind(this));this.xhr.addEventListener("load",this._onStreamLoaded.bind(this));this.xhr.addEventListener("readystatechange",this._checkStreamClosed.bind(this));this.xhr.addEventListener("error",this._onStreamFailure.bind(this));this.xhr.addEventListener("abort",this._onStreamAbort.bind(this));this.xhr.open(this.method,this.url);for(let n in this.headers)this.xhr.setRequestHeader(n,this.headers[n]);this.lastEventId.length>0&&this.xhr.setRequestHeader("Last-Event-ID",this.lastEventId);this.xhr.withCredentials=this.withCredentials;this.xhr.send(this.payload)}};this.close=function(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this._setReadyState(this.CLOSED))};(t.start===undefined||t.start)&&this.stream()};
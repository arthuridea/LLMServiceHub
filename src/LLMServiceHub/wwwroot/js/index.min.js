function dateFormat(n,t){let i;const r={"Y+":t.getFullYear().toString(),"m+":(t.getMonth()+1).toString(),"d+":t.getDate().toString(),"H+":t.getHours().toString(),"M+":t.getMinutes().toString(),"S+":t.getSeconds().toString()};for(let t in r)i=new RegExp("("+t+")").exec(n),i&&(n=n.replace(i[1],i[1].length==1?r[t]:r[t].padStart(i[1].length,"0")));return n}function syncCurrentVal(n,t){$(`#${n}-val`).val(t);conversations.ConvErnieTurbo[n]=parseFloat(t);conversations.ConvErnie3_5[n]=parseFloat(t);conversations.ConvErnie4_0[n]=parseFloat(t);$(".llm-model-config").each(function(n,t){let r=$(t).data("llm-name"),i=conversations[r];$(t).html(`温度:${i.temperature};多样性:${i.top_p};惩罚系数:${i.penalty_score};`)})}function exportBlob(n,t){const u=new Blob([n],{type:"text/plain"}),r=URL.createObjectURL(u),i=document.createElement("a");i.href=r;i.download=t;document.body.appendChild(i);i.click();document.body.removeChild(i);URL.revokeObjectURL(r)}let useSSE=!0,m_t=.95,m_tp=.8,m_ps=1,_con_id={ConvErnie3_5:"",ConvErnieTurbo:"",ConvErnie4_0:""},conversations={ConvErnieTurbo:{temperature:m_t||.95,top_p:m_tp||.8,penalty_score:m_ps||1,stream:useSSE,conversation_id:"conv-turbo",message:"",model:2,user_id:"7ffe3194-2bf0-48ba-8dbd-e888d7d556d3"},ConvErnie3_5:{temperature:m_t||.95,top_p:m_tp||.8,penalty_score:m_ps||1,conversation_id:"conv-3_5",message:"",model:1,stream:useSSE,user_id:"7ffe3194-2bf0-48ba-8dbd-e888d7d556d3"},ConvErnie4_0:{temperature:m_t||.95,top_p:m_tp||.8,penalty_score:m_ps||1,stream:useSSE,conversation_id:"conv-4_0",message:"",model:3,user_id:"7ffe3194-2bf0-48ba-8dbd-e888d7d556d3"}};$("#r-temperature").val(m_t);$("#temperature-val").val(m_t);$("#r-top_p").val(m_tp);$("#top_p-val").val(m_tp);$("#r-penalty_score").val(m_ps);$("#penalty_score-val").val(m_ps);$(".llm-model-config").html(`温度:${m_t};多样性:${m_tp};惩罚系数:${m_ps};`);$(".llm-range-picker").on("change",function(){let n=$(this),t=$(n).val(),i=$(n).data("sync-key");syncCurrentVal(i,t)});$(".btn-discard-llm-setting").on("click",function(){let i=$(this),n=$(i).data("val"),t=$(i).data("rel-key");console.log(n);console.log(t);$(`#r-${t}`).val(n);syncCurrentVal(t,n)});let sendBtnClickEventHandler=async function(n){let t=$("#ipt-message").val();$("#ipt-message").val("");$(Object.keys(conversations)).each(async function(n,i){var o,c;if(console.log(`key->${i}`),o=$("#chk-"+i).is(":checked"),console.log(`MODEL: ${i} -> ${o}`),o){let l=Math.random().toString(36).slice(-8),r=conversations[i],w="#wrapper_"+i;r.message=t;_con_id[i]!=""?(console.log(`conversation_id found: ${_con_id[i]}`),r.conversation_id=_con_id[i]):(r.conversation_id=`${r.conversation_id}_${l}`,_con_id[i]=r.conversation_id);let u=$(w);if(u){let d=dateFormat("HH:MM:SS",new Date),n=`rpl_${l}`,o;switch(i){case"ConvErnieTurbo":o="ernie_turbo";break;case"ConvErnie3_5":o="ernie_3_5";break;case"ConvErnie4_0":o="ernie_4_0"}const g=`
                        <div class="chat-item">
                            <div class="row align-items-end justify-content-end">
                                <div class="col col-lg-8">
                                    <div class="chat-bubble chat-bubble-me">
                                        <div class="chat-bubble-title">
                                            <div class="row">
                                                <div class="col chat-bubble-author pb-2">${"我"}</div>
                                                <div class="col-auto chat-bubble-date">${d}</div>
                                            </div>
                                        </div>
                                        <div class="chat-bubble-body">
                                            <p>${t}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <span class="avatar">我</span>
                                </div>
                            </div>
                        </div>
                        `,nt=`
                         <div class="chat-item">
                             <div class="row align-items-end">
                                 <div class="col-auto">
                                     <span class="avatar">百</span>
                                 </div>
                                 <div class="col col-lg-8">
                                     <div class="chat-bubble">
                                         <div class="chat-bubble-title">
                                             <div class="row">
                                                 <div class="col chat-bubble-author pb-2">${o}</div>
                                                 <div class="col-auto chat-bubble-date" id='reply_time_${n}'></div>
                                             </div>
                                         </div>
                                         <div class="chat-bubble-body" id='reply_${n}'>
                                         </div>
                                         <input type='hidden' id='reply_hid_${n}' value='' />
                                     </div>
                                 </div>
                             </div>
                         </div>
                         `;$(g).appendTo($(u));$(nt).appendTo($(u));let w=$(u).closest(".scrollable"),tt=$(w).height();$(w).scrollTop(tt);console.log("sending request with:");console.log(r);var a=!1,b=12e4,v=[],f=0,e=0,s=-1,h=null,y=50,p=0,k=function(){var i,t,r,o,c,l,a;if(p>b&&clearInterval(h),i=v[f],i){if(t=i.chunk||"",s>0&&(f==s||!t)){clearInterval(h);f=0;return}r=0;t&&(r=t.length||0,o=t[e]||"",o&&(c=($(`#reply_hid_${n}`).val()||"")+o,$(`#reply_hid_${n}`).val(c),$(`#reply_${n}`).html(marked.parse(c)),l=$(u).closest(".scrollable"),a=$(l).prop("scrollTop")+$("#reply_"+n).height(),$(l).scrollTop(a)));e++;e==r&&(e=0,f++);p+=y}};EventSource=SSE;c=new SSE(apiEndpoint,{headers:{"Content-Type":"application/json"},payload:JSON.stringify(r),withCredentials:!0,debug:!1,start:!1,method:"POST"});c.addEventListener("message",function(t){var u=useSSE?t.data:t.source.chunk,i=JSON.parse(u),r;i&&(r=i.aigc_message,v.push({row:i.llm_response_data.sentence_id,chunk:r.split("")}),a||($(`#reply_time_${n}`).html(dateFormat("HH:MM:SS",new Date)),h=setInterval(k,y),a=!0),i.llm_response_data.is_end&&(s=i.llm_response_data.sentence_id))});c.stream()}}});n.preventDefault()};$(document).on("keyup",function(n){var t=n||window.event,i=t.which||t.keyCode||t.charCode;i==13&&t.ctrlKey&&sendBtnClickEventHandler(n)});$(".btn-send-message").on("click",sendBtnClickEventHandler);$(".btn-export").on("click",function(){let t=dateFormat("YYYYmmddHHMMSS",new Date),r=$(this).closest(".card"),u=$(this).data("key")+"-"+t+".txt",f=$(r).find(".chat-bubble"),n=[];n.push(`--------------${t}-------------
`);$(f).each(function(t,i){let r=$(i).find(".chat-bubble-author").text(),u=$(i).find(".chat-bubble-date").text(),f=$(i).find(".chat-bubble-body").text();n.push(`[${r}]  ${u}

`);n.push(f.trim());n.push("\r\n-------------------------------\r\n")});let i=n.join("");console.log(i);exportBlob(i,u)});